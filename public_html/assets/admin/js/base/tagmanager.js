/* ===================================================
 * tagmanager.js v3.0.2
 * http://welldonethings.com/tags/manager
 * ===================================================
 * Copyright 2012 Max Favilli
 *
 * Licensed under the Mozilla Public License, Version 2.0 You may not use this work except in compliance with the License.
 *
 * http://www.mozilla.org/MPL/2.0/
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function(a){"use strict";var t={prefilled:null,CapitalizeFirstLetter:!1,preventSubmitOnEnter:!0,isClearInputOnEsc:!0,externalTagId:!1,prefillIdFieldName:"Id",prefillValueFieldName:"Value",AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:!0,output:null,deleteTagsOnBackspace:!0,tagsContainer:null,tagCloseIcon:"x",tagClass:"",validator:null,onlyTagList:!1,tagList:null,fillInputOnTagRemove:!1,AjaxPushDataType:"json"},e={pushTag:function(t,e,l){var r,n,s,o,d,p,u,g,h,c,f=a(this),m=f.data("opts"),v=f.data("tlis"),T=f.data("tlid");if((t=i.trimTag(t,m.delimiterChars))&&!(t.length<=0)){if(m.onlyTagList&&void 0!==m.tagList&&m.tagList){var y=m.tagList;if(a.each(y,function(a,t){y[a]=t.toLowerCase()}),-1===a.inArray(t.toLowerCase(),y))return}if(m.CapitalizeFirstLetter&&t.length>1&&(t=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()),!m.validator||m.validator(t)){if(!(m.maxTags>0&&v.length>=m.maxTags)){if(r=!1,n=jQuery.map(v,function(a){return a.toLowerCase()}),-1!==(d=a.inArray(t.toLowerCase(),n))&&(r=!0),r)if(f.trigger("tm:duplicated",t),m.blinkClass)for(var C=0;C<6;++C)a("#"+f.data("tm_rndid")+"_"+T[d]).queue(function(t){a(this).toggleClass(m.blinkClass),t()}).delay(100);else a("#"+f.data("tm_rndid")+"_"+T[d]).stop().animate({backgroundColor:m.blinkBGColor_1},100).animate({backgroundColor:m.blinkBGColor_2},100).animate({backgroundColor:m.blinkBGColor_1},100).animate({backgroundColor:m.blinkBGColor_2},100).animate({backgroundColor:m.blinkBGColor_1},100).animate({backgroundColor:m.blinkBGColor_2},100);else{!0===m.externalTagId?(void 0===l&&a.error("externalTagId is not passed for tag -"+t),o=l):(s=(s=Math.max.apply(null,T))===-1/0?0:s,o=++s),e||f.trigger("tm:pushing",[t,o]),v.push(t),T.push(o),e||null!==m.AjaxPush&&null==m.AjaxPushAllTags&&-1===a.inArray(t,m.prefilled)&&a.post(m.AjaxPush,a.extend({tag:t},m.AjaxPushParameters),null,m.AjaxPushDataType),p=f.data("tm_rndid")+"_"+o,u=f.data("tm_rndid")+"_Remover_"+o,g=a("<span/>").text(t).html(),h='<span class="'+i.tagClasses.call(f)+'" id="'+p+'">',h+="<span>"+g+"</span>",h+='<a href="#" class="tm-tag-remove" id="'+u+'" TagIdToRemove="'+o+'">',h+=m.tagCloseIcon+"</a></span> ",c=a(h);var A=void 0!==f.parents(".twitter-typeahead")[0];if(null!==m.tagsContainer)a(m.tagsContainer).append(c);else if(T.length>1)if(A){var b=f.data("tm_rndid")+"_"+--o;jQuery("#"+b).after(c)}else f.siblings("#"+f.data("tm_rndid")+"_"+T[T.length-2]).after(c);else A?f.parents(".twitter-typeahead").before(c):f.before(c);c.find("#"+u).on("click",f,function(t){t.preventDefault();var e=parseInt(a(this).attr("TagIdToRemove"));i.spliceTag.call(f,e,t.data)}),i.refreshHiddenTagList.call(f),e||f.trigger("tm:pushed",[t,o]),i.showOrHide.call(f)}f.val("")}}else f.trigger("tm:invalid",t)}},popTag:function(){var t,e,l=a(this),r=l.data("tlis"),n=l.data("tlid");n.length>0&&(t=n.pop(),e=r[r.length-1],l.trigger("tm:popping",[e,t]),r.pop(),a("#"+l.data("tm_rndid")+"_"+t).remove(),i.refreshHiddenTagList.call(l),l.trigger("tm:popped",[e,t]),i.showOrHide.call(l))},empty:function(){for(var t,e=a(this),l=e.data("tlis"),r=e.data("tlid");r.length>0;)t=r.pop(),l.pop(),a("#"+e.data("tm_rndid")+"_"+t).remove(),i.refreshHiddenTagList.call(e);e.trigger("tm:emptied",null),i.showOrHide.call(e)},tags:function(){return this.data("tlis")}},i={showOrHide:function(){var a=this,t=a.data("opts"),e=a.data("tlis");t.maxTags>0&&e.length<t.maxTags&&(a.show(),a.trigger("tm:show")),t.maxTags>0&&e.length>=t.maxTags&&(a.hide(),a.trigger("tm:hide"))},tagClasses:function(){var t,e=a(this),i=e.data("opts"),l=i.tagBaseClass,r=i.inputBaseClass;return t=l,e.attr("class")&&a.each(e.attr("class").split(" "),function(a,e){-1!==e.indexOf(r+"-")&&(t+=" "+l+e.substring(r.length))}),t+=i.tagClass?" "+i.tagClass:""},trimTag:function(t,e){var i;for(t=a.trim(t),i=0;i<t.length&&-1===a.inArray(t.charCodeAt(i),e);i++);return t.substring(0,i)},refreshHiddenTagList:function(){var t=a(this),e=t.data("tlis"),i=t.data("lhiddenTagList");i&&a(i).val(e.join(t.data("opts").baseDelimiter)).change(),t.trigger("tm:refresh",e.join(t.data("opts").baseDelimiter))},killEvent:function(a){a.cancelBubble=!0,a.returnValue=!1,a.stopPropagation(),a.preventDefault()},keyInArray:function(t,e){return-1!==a.inArray(t.which,e)},applyDelimiter:function(t){var i=a(this);e.pushTag.call(i,a(this).val()),t.preventDefault()},prefill:function(t){var i=a(this),l=i.data("opts");a.each(t,function(a,t){!0===l.externalTagId?e.pushTag.call(i,t[l.prefillValueFieldName],!0,t[l.prefillIdFieldName]):e.pushTag.call(i,t,!0)})},pushAllTags:function(t,e){var i=a(this),l=i.data("opts"),r=i.data("tlis");l.AjaxPushAllTags&&("tm:pushed"===t.type&&-1!==a.inArray(e,l.prefilled)||a.post(l.AjaxPush,a.extend({tags:r.join(l.baseDelimiter)},l.AjaxPushParameters)))},spliceTag:function(t){var e,l=this,r=l.data("tlis"),n=l.data("tlid"),s=a.inArray(t,n);-1!==s&&(e=r[s],l.trigger("tm:splicing",[e,t]),a("#"+l.data("tm_rndid")+"_"+t).remove(),r.splice(s,1),n.splice(s,1),i.refreshHiddenTagList.call(l),l.trigger("tm:spliced",[e,t])),i.showOrHide.call(l)},init:function(l){var r,n,s=a.extend({},t,l);return s.hiddenTagListName=null===s.hiddenTagListName?"hidden-"+this.attr("name"):s.hiddenTagListName,r=s.delimeters||s.delimiters,n=[9,13,17,18,19,37,38,39,40],s.delimiterChars=[],s.delimiterKeys=[],a.each(r,function(t,e){-1!==a.inArray(e,n)?s.delimiterKeys.push(e):s.delimiterChars.push(e)}),s.baseDelimiter=String.fromCharCode(s.delimiterChars[0]||44),s.tagBaseClass="tm-tag",s.inputBaseClass="tm-input",a.isFunction(s.validator)||(s.validator=null),this.each(function(){var t=a(this),l="",r="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";if(t.data("tagManager"))return!1;t.data("tagManager",!0);for(var o=0;o<5;o++)r+=n.charAt(Math.floor(Math.random()*n.length));if(t.data("tm_rndid",r),t.data("opts",s).data("tlis",[]).data("tlid",[]),null===s.output?(l=a("<input/>",{type:"hidden",name:s.hiddenTagListName}),t.after(l),t.data("lhiddenTagList",l)):t.data("lhiddenTagList",a(s.output)),s.AjaxPushAllTags&&(t.on("tm:spliced",i.pushAllTags),t.on("tm:popped",i.pushAllTags),t.on("tm:pushed",i.pushAllTags)),t.on("focus keypress",function(t){a(this).popover&&a(this).popover("hide")}),s.isClearInputOnEsc&&t.on("keyup",function(t){27===t.which&&(a(this).val(""),i.killEvent(t))}),t.on("keypress",function(a){i.keyInArray(a,s.delimiterChars)&&i.applyDelimiter.call(t,a)}),t.on("keydown",function(a){13===a.which&&s.preventSubmitOnEnter&&i.killEvent(a),i.keyInArray(a,s.delimiterKeys)&&i.applyDelimiter.call(t,a)}),s.deleteTagsOnBackspace&&t.on("keydown",function(l){i.keyInArray(l,s.backspace)&&a(this).val().length<=0&&(e.popTag.call(t),i.killEvent(l))}),s.fillInputOnTagRemove&&t.on("tm:popped",function(t,e){a(this).val(e)}),t.change(function(a){/webkit/.test(navigator.userAgent.toLowerCase())||t.focus(),i.killEvent(a)}),null!==s.prefilled)"object"==typeof s.prefilled?i.prefill.call(t,s.prefilled):"string"==typeof s.prefilled?i.prefill.call(t,s.prefilled.split(s.baseDelimiter)):"function"==typeof s.prefilled&&i.prefill.call(t,s.prefilled());else if(null!==s.output){if(a(s.output)&&a(s.output).val())a(s.output);i.prefill.call(t,a(s.output).val().split(s.baseDelimiter))}}),this}};a.fn.tagsManager=function(t){var l=a(this);return 0 in this?e[t]?e[t].apply(l,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?(a.error("Method "+t+" does not exist."),!1):i.init.apply(this,arguments):this}}(jQuery);